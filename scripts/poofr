#!/bin/zsh

# Path to the plunk file generated by the previous script
pluckfile=~/note-vault/computed/plucked.md

# Read the pluck file line by line
while IFS= read -r line
do
  # If the line starts with "- [[", it contains the file name and line number
  if [[ $line == "- [[ "* ]]; then
    # Extract the file name
    filename=$(echo $line | awk -F'|' '{gsub("- \\[\\[", ""); print $1}')
    # Extract the line number
    lineno=$(echo $line | awk -F': line ' '{print $2}')
    # Create a temporary file
    tempfile=$(mktemp)
    # Read the original file line by line
    lineno=$((lineno+1)) # Adjust line number to match 'awk' behavior (which starts from 1)
    awk -v lineno=$lineno -v tempfile=$tempfile '{
      if (NR == lineno) {
        gsub("\\[\\[pluck\\]\\]", "")
      }
      print >> tempfile
    }' $filename
    # Replace the original file with the temporary file
    mv $tempfile $filename
  fi
done < $pluckfile

